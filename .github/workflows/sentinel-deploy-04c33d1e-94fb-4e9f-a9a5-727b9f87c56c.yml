name: Deploy Content to law-project [04c33d1e-94fb-4e9f-a9a5-727b9f87c56c]

on:
  push:
    branches: [ main ]
    paths:
      - '**'
      - '!.github/workflows/**'   # prevent loop from workflow edits
      - '.github/workflows/sentinel-deploy-04c33d1e-94fb-4e9f-a9a5-727b9f87c56c.yml'
  workflow_dispatch:

jobs:
  deploy-content:
    runs-on: windows-latest

    # Passed to the generated PS1
    env:
      resourceGroupName: 'project-rg'
      workspaceName: 'law-project'
      workspaceId: 'a6fb6f7b-9014-4f92-a102-11d22077e6ea'
      directory: '${{ github.workspace }}'
      cloudEnv: 'AzureCloud'
      contentTypes: 'AnalyticsRule,AutomationRule,HuntingQuery,Parser,Playbook,Workbook'
      branch: 'main'
      sourceControlId: '04c33d1e-94fb-4e9f-a9a5-727b9f87c56c'
      rootDirectory: '${{ github.workspace }}'
      githubAuthToken: ${{ secrets.GITHUB_TOKEN }}
      smartDeployment: 'true'

    permissions:
      contents: write
      id-token: write   # needed for OIDC login

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ---------- Login (with retry) ----------
      - name: Login to Azure (Attempt 1)
        id: login1
        continue-on-error: true
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_SENTINEL_CLIENTID_04c33d1e94fb4e9fa9a5727b9f87c56c }}
          tenant-id: ${{ secrets.AZURE_SENTINEL_TENANTID_04c33d1e94fb4e9fa9a5727b9f87c56c }}
          subscription-id: ${{ secrets.AZURE_SENTINEL_SUBSCRIPTIONID_04c33d1e94fb4e9fa9a5727b9f87c56c }}
          environment: AzureCloud
          audience: api://AzureADTokenExchange
          enable-AzPSSession: true

      - name: Wait 30s if login 1 failed
        if: ${{ steps.login1.outcome == 'failure' }}
        run: Start-Sleep -Seconds 30

      - name: Login to Azure (Attempt 2)
        id: login2
        if: ${{ steps.login1.outcome == 'failure' }}
        continue-on-error: true
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_SENTINEL_CLIENTID_04c33d1e94fb4e9fa9a5727b9f87c56c }}
          tenant-id: ${{ secrets.AZURE_SENTINEL_TENANTID_04c33d1e94fb4e9fa9a5727b9f87c56c }}
          subscription-id: ${{ secrets.AZURE_SENTINEL_SUBSCRIPTIONID_04c33d1e94fb4e9fa9a5727b9f87c56c }}
          environment: AzureCloud
          audience: api://AzureADTokenExchange
          enable-AzPSSession: true

      - name: Wait 30s if login 2 failed
        if: ${{ steps.login2.outcome == 'failure' }}
        run: Start-Sleep -Seconds 30

      - name: Login to Azure (Attempt 3)
        id: login3
        if: ${{ steps.login1.outcome == 'failure' && steps.login2.outcome == 'failure' }}
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_SENTINEL_CLIENTID_04c33d1e94fb4e9fa9a5727b9f87c56c }}
          tenant-id: ${{ secrets.AZURE_SENTINEL_TENANTID_04c33d1e94fb4e9fa9a5727b9f87c56c }}
          subscription-id: ${{ secrets.AZURE_SENTINEL_SUBSCRIPTIONID_04c33d1e94fb4e9fa9a5727b9f87c56c }}
          environment: AzureCloud
          audience: api://AzureADTokenExchange
          enable-AzPSSession: true
      # ---------- /Login ----------

      - name: Show Az context (debug)
        run: |
          Write-Host "Az Context:"; Get-AzContext | Format-List

      - name: Deploy Content to Microsoft Sentinel
        uses: azure/powershell@v2
        with:
          azPSVersion: latest
          inlineScript: |
            $ErrorActionPreference = 'Stop'
            $script = Join-Path $env:GITHUB_WORKSPACE '.github/workflows/azure-sentinel-deploy-04c33d1e-94fb-4e9f-a9a5-727b9f87c56c.ps1'
            if (-not (Test-Path $script)) {
              Write-Host "Repository contents:"; Get-ChildItem -Recurse $env:GITHUB_WORKSPACE | Select FullName
              throw "Script not found: $script"
            }
            Write-Host "Running script: $script"
            & $script `
              -Directory         $env:GITHUB_WORKSPACE `
              -ResourceGroupName $env:resourceGroupName `
              -WorkspaceName     $env:workspaceName `
              -WorkspaceId       $env:workspaceId `
              -CloudEnv          $env:cloudEnv `
              -ContentTypes      $env:contentTypes `
              -Branch            $env:branch `
              -SourceControlId   $env:sourceControlId `
              -RootDirectory     $env:rootDirectory `
              -GithubAuthToken   $env:githubAuthToken `
              -SmartDeployment   $env:smartDeployment
